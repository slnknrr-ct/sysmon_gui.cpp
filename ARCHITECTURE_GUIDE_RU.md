# Руководство по архитектуре SysMon3

Этот документ предоставляет комплексный обзор архитектуры проекта SysMon3, включая отношения компонентов, потоки данных и дизайн системы.

## Обзор проекта

SysMon3 - это кроссплатформенный инструмент мониторинга и управления системой, состоящий из двух основных компонентов:
- **Агент** - Фоновый сервис для мониторинга системных ресурсов
- **GUI** - Графический интерфейс на основе Qt для визуализации и управления

## Архитектура высокого уровня

```
┌─────────────────┐    TCP/IP     ┌─────────────────┐
│   GUI Клиент    │ ◄──────────► │   Агент Сервер  │
│                 │               │                 │
│ - Qt Интерфейс  │               │ - Монитор системы│
│ - IPC Клиент    │               │ - Менеджер устройств│
│ - Вкладки       │               │ - Менеджер сети │
└─────────────────┘               │ - Менеджер процессов│
                                 │ - Менеджер Android│
                                 │ - Движок автоматизации│
                                 └─────────────────┘
```

## Структура каталогов

```
sysmon3_gui.cpp/
├── CMakeLists.txt          # Основная конфигурация сборки
├── .build.bat             # Скрипт сборки для Windows
├── sysmon.desktop         # Запись рабочего стола Linux
├── sysmon_agent.conf.example # Шаблон конфигурации агента
├── agent/                 # Компонент агента-сервера
│   ├── CMakeLists.txt
│   ├── main.cpp           # Точка входа агента
│   ├── agentcore.h/cpp    # Основная оркестрация агента
│   ├── ipcserver.h/cpp    # Реализация IPC сервера
│   ├── systemmonitor.h/cpp # Мониторинг системы
│   ├── devicemanager.h/cpp # Управление устройствами
│   ├── networkmanager.h/cpp # Мониторинг сети
│   ├── processmanager.h/cpp # Управление процессами
│   ├── androidmanager.h/cpp # Управление устройствами Android
│   ├── automationengine.h/cpp # Движок правил автоматизации
│   ├── logger.h/cpp       # Система логирования
│   └── configmanager.h/cpp # Управление конфигурацией
├── gui/                   # Компонент GUI клиента
│   ├── CMakeLists.txt
│   ├── main.cpp           # Точка входа GUI
│   ├── mainwindow.h/cpp   # Главное окно приложения
│   ├── ipcclient.h/cpp    # Реализация IPC клиента
│   ├── systemmonitortab.h/cpp # Вкладка монитора системы
│   ├── devicemanagertab.h/cpp # Вкладка менеджера устройств
│   ├── networkmanagertab.h/cpp # Вкладка менеджера сети
│   ├── processmanagertab.h/cpp # Вкладка менеджера процессов
│   ├── androidtab.h/cpp   # Вкладка Android устройств
│   ├── automationtab.h/cpp # Вкладка правил автоматизации
│   └── logger.h/cpp       # Логирование GUI
├── shared/                # Общие компоненты
│   ├── CMakeLists.txt
│   ├── systemtypes.h/cpp  # Общие структуры данных
│   ├── commands.h/cpp     # Определения команд/ответов
│   ├── ipcprotocol.h/cpp  # Реализация IPC протокола
│   └── constants.h        # Системные константы
└── build/                 # Директория сборки
```

## Архитектура компонентов

### 1. Общая библиотека

#### Назначение
Предоставляет общие структуры данных и IPC протокол, используемые как агентом, так и GUI.

#### Ключевые компоненты
- **SystemTypes** - Структуры данных для системной информации
- **Commands** - Определения сообщений команда/ответ
- **IpcProtocol** - Сериализация/десериализация на основе JSON

#### Структуры данных
```cpp
struct SystemInfo {
    double cpuUsageTotal;
    std::vector<double> cpuCoresUsage;
    uint64_t memoryTotal, memoryUsed, memoryFree;
    uint32_t processCount, threadCount;
    std::chrono::seconds uptime;
};

struct ProcessInfo {
    uint32_t pid;
    std::string name;
    double cpuUsage;
    uint64_t memoryUsage;
    std::string status;
    uint32_t parentPid;
    std::string user;
};
```

### 2. Компонент агента

#### Архитектурный паттерн
Агент следует **компонентной архитектуре** с центральным оркестратором.

#### Основные компоненты

##### AgentCore (Оркестратор)
- **Назначение**: Центральная координация всех компонентов агента
- **Ответственность**:
  - Управление жизненным циклом компонентов
  - Обработка и маршрутизация команд
  - Широковещательная рассылка событий клиентам
  - Управление рабочими потоками

##### IPC Сервер
- **Назначение**: Обработка коммуникации с GUI клиентами
- **Возможности**:
  - Поддержка нескольких клиентов (до 10 одновременных)
  - Коммуникация на основе TCP сокетов
  - Протокол сообщений JSON
  - Управление клиентскими подключениями

##### Монитор системы
- **Назначение**: Мониторинг системных ресурсов в реальном времени
- **Возможности**:
  - Мониторинг использования CPU (общий и на ядро)
  - Отслеживание использования памяти
  - Подсчет процессов и потоков
  - Отслеживание времени работы системы

##### Менеджер устройств
- **Назначение**: Управление USB и аппаратными устройствами
- **Возможности**:
  - Обнаружение и перечисление USB устройств
  - Мониторинг статуса подключения устройств
  - Получение информации об устройствах

##### Менеджер сети
- **Назначение**: Мониторинг сетевых интерфейсов
- **Возможности**:
  - Перечисление сетевых интерфейсов
  - Отслеживание IP-адресов (IPv4/IPv6)
  - Мониторинг сетевого трафика
  - Мониторинг статуса интерфейсов

##### Менеджер процессов
- **Назначение**: Мониторинг и управление процессами
- **Возможности**:
  - Перечисление процессов
  - Отслеживание использования ресурсов процессами
  - Управление жизненным циклом процессов

##### Менеджер Android
- **Назначение**: Интеграция с устройствами Android
- **Возможности**:
  - Обнаружение ADB устройств
  - Получение информации об устройствах
  - Мониторинг уровня заряда батареи
  - Отслеживание состояния экрана

##### Движок автоматизации
- **Назначение**: Система автоматизации на основе правил
- **Возможности**:
  - Определение и управление правилами
  - Оценка условий
  - Выполнение действий
  - Планирование правил

#### Поток данных в агенте
```
GUI Клиент --[Команда]--> IPC Сервер --[Команда]--> AgentCore
AgentCore --[Команда]--> Специфичный Менеджер --> [Ответ] --> AgentCore
AgentCore --[Ответ]--> IPC Сервер --[Ответ]--> GUI Клиент

Системные события --> Менеджеры --> AgentCore --[Событие]--> IPC Сервер --> Все GUI Клиенты
```

### 3. Компонент GUI

#### Архитектурный паттерн
GUI следует паттерну **Model-View-Controller (MVC)** с механизмом сигнал/слот Qt.

#### Основные компоненты

##### Главное окно
- **Назначение**: Основной контейнер приложения и координатор
- **Возможности**:
  - Панель меню и строка состояния
  - Интерфейс на основе вкладок
  - Управление подключениями
  - Обновления статуса

##### IPC Клиент
- **Назначение**: Коммуникация с сервером агента
- **Возможности**:
  - Асинхронная отправка команд
  - Обработка ответов через колбэки
  - Автоматическое переподключение
  - Мониторинг статуса подключения

##### Виджеты вкладок
Каждая область управления системой имеет свою вкладку:
- **Вкладка монитора системы** - Метрики системы в реальном времени
- **Вкладка менеджера устройств** - Управление USB устройствами
- **Вкладка менеджера сети** - Мониторинг сетевых интерфейсов
- **Вкладка менеджера процессов** - Интерфейс управления процессами
- **Вкладка Android** - Управление устройствами Android
- **Вкладка автоматизации** - Конфигурация и управление правилами

#### Поток данных в GUI
```
Действие пользователя --> Виджет вкладки --> IPC Клиент --> Агент
Ответ агента --> IPC Клиент --> Виджет вкладки --> Обновление UI
События агента --> IPC Клиент --> Виджеты вкладок --> Обновления в реальном времени
```

## Протокол коммуникации

### Дизайн IPC протокола

#### Типы сообщений
1. **Команды** - Сообщения запроса от GUI к Агенту
2. **Ответы** - Сообщения ответа от Агента к GUI
3. **События** - Сообщения широковещательной рассылки от Агента всем GUI клиентам

#### Формат сообщений
Все сообщения используют формат JSON для независимости от языка:
```json
{
  "type": "command|response|event",
  "id": "unique_message_id",
  "timestamp": "2023-01-01T12:00:00Z",
  "module": "system|device|network|process|android|automation",
  "command": "get_system_info|list_processes|...",
  "status": "success|failed|pending",
  "data": { ... }
}
```

#### Примеры команд

##### Получение системной информации
```json
{
  "type": "command",
  "id": "cmd_001",
  "module": "system",
  "command": "get_system_info"
}
```

##### Ответ
```json
{
  "type": "response",
  "id": "cmd_001",
  "status": "success",
  "data": {
    "cpuUsageTotal": 45.2,
    "memoryUsed": 8589934592,
    "processCount": 156
  }
}
```

##### Системное событие
```json
{
  "type": "event",
  "id": "evt_001",
  "module": "device",
  "event": "device_connected",
  "data": {
    "deviceId": "usb_001",
    "deviceName": "USB Flash Drive"
  }
}
```

## Модель потоков

### Потоки в агенте

#### Структура потоков
1. **Основной поток** - Жизненный цикл приложения и обработка сигналов
2. **Рабочий поток** - Обработка команд и оркестрация
3. **Поток сервера** - Принятие клиентских подключений
4. **Потоки клиентов** - Индивидуальная коммуникация с клиентами (один на клиента)

#### Потокобезопасность
- **Shared Mutex** - Защищает разделяемые структуры данных
- **Атомарные флаги** - Потокобезопасное управление статусом
- **Локальное хранилище потоков** - Управление состоянием ошибок

### Потоки в GUI

#### Модель потоков Qt
- **Основной GUI поток** - Рендеринг UI и взаимодействие с пользователем
- **Поток IPC клиента** - Сетевая коммуникация (обрабатывается Qt)
- **Потоки таймеров** - Периодические обновления (обрабатываются Qt)

#### Подключения сигнал/слот
- **Очередные подключения** - Межпотоковая коммуникация
- **Прямые подключения** - Коммуникация в том же потоке
- **Авто подключения** - Qt определяет тип подключения

## Управление конфигурацией

### Конфигурация агента

#### Расположение файла конфигурации
- **Linux**: `/etc/sysmon/sysmon_agent.conf`
- **Windows**: `%PROGRAMDATA%\SysMon\sysmon_agent.conf`

#### Секции конфигурации
```ini
[server]
port=12345
max_clients=10
timeout=300

[logging]
level=INFO
file=/var/log/sysmon/agent.log
max_size=10MB

[system]
update_interval=1000
enable_automation=true

[android]
adb_path=/usr/bin/adb
timeout=30
```

### Конфигурация GUI

#### Хранение настроек
- **Настройки Qt** - Специфичное для платформы хранение настроек
- **Windows**: Реестр
- **Linux**: Файлы конфигурации
- **macOS**: Списки свойств

#### Категории конфигурации
- Настройки подключения
- Предпочтения UI
- Конфигурации вкладок
- Опции отображения

## Обработка ошибок

### Стратегия обработки ошибок

#### Многоуровневая обработка ошибок
1. **Уровень функций** - Локальное восстановление ошибок
2. **Уровень компонентов** - Управление состоянием ошибок компонентов
3. **Системный уровень** - Отчеты об ошибках на уровне приложения

#### Распространение ошибок
- **Коды возврата** - Традиционные коды ошибок для простых случаев
- **Исключения** - Обработка ошибок на основе исключений для сложных случаев
- **Колбэки** - Асинхронное уведомление об ошибках
- **События** - Широковещательная рассылка ошибок клиентам

#### Восстановление ошибок
- **Автоматическое переподключение** - Восстановление сетевых подключений
- **Graceful degradation** - Снижение функциональности при ошибках
- **Перезапуск компонентов** - Автоматический перезапуск компонентов при сбоях

## Соображения безопасности

### Меры безопасности

#### Сетевая безопасность
- **Только localhost** - Привязка только к localhost по умолчанию
- **Опциональная аутентификация** - Настраиваемая аутентификация
- **Лимиты подключений** - Максимальные лимиты клиентских подключений
- **Защита от таймаутов** - Управление таймаутами подключений

#### Защита данных
- **Валидация ввода** - Проверка всех входящих данных
- **Лимиты ресурсов** - Предотвращение атак истощения ресурсов
- **Безопасные настройки по умолчанию** - Безопасная конфигурация по умолчанию

#### Контроль доступа
- **Система разрешений** - Контроль доступа на основе ролей
- **Авторизация команд** - Проверка разрешений на уровне команд
- **Доступ к ресурсам** - Контролируемый доступ к ресурсам

## Оптимизация производительности

### Производительность агента

#### Эффективный сбор данных
- **Пакетные операции** - Группировка нескольких операций
- **Кэширование** - Кэширование часто используемых данных
- **Ленивая загрузка** - Загрузка данных по требованию
- **Пулы памяти** - Пользовательские аллокаторы для частых выделений

#### Оптимизация потоков
- **Операции без блокировок** - Атомарные операции где возможно
- **Блокировки чтения-записи** - Несколько читателей, один писатель
- **Пулы потоков** - Повторное использование потоков для операций

### Производительность GUI

#### Отзывчивость UI
- **Асинхронные операции** - Неблокирующие операции UI
- **Прогрессивная загрузка** - Постепенная загрузка данных
- **Виртуальная прокрутка** - Эффективное отображение больших наборов данных
- **Фоновая обработка** - Перенос работы с UI потока

#### Управление памятью
- **Умные указатели** - Автоматическое управление памятью
- **Объектные пулы** - Повторное использование объектов UI
- **Очистка ресурсов** - Своевременное освобождение ресурсов

## Архитектура развертывания

### Система сборки

#### Конфигурация CMake
- **Современный CMake** - Конфигурация на основе целей
- **Кроссплатформенность** - Поддержка Windows, Linux, macOS
- **Компонентная сборка** - Отдельная сборка для каждого компонента
- **Управление зависимостями** - Автоматическое разрешение зависимостей

#### Цели сборки
- **sysmon_shared** - Общая библиотека
- **sysmon_agent** - Исполняемый файл агента
- **sysmon_gui** - Исполняемый файл GUI

### Установка

#### Структура пакета
```
/usr/local/bin/
├── sysmon_agent          # Исполняемый файл агента
└── sysmon_gui            # Исполняемый файл GUI

/usr/local/lib/
└── libsysmon_shared.a    # Общая библиотека

/usr/local/include/sysmon/
├── systemtypes.h
├── commands.h
└── ipcprotocol.h

/etc/sysmon/
└── sysmon_agent.conf     # Конфигурация агента

/usr/share/applications/
└── sysmon.desktop        # Запись рабочего стола Linux
```

#### Интеграция сервисов
- **Сервис systemd** - Интеграция с сервисом Linux
- **Сервис Windows** - Интеграция с сервисом Windows
- **Launch Agent** - Интеграция с сервисом macOS

## Мониторинг и отладка

### Система логирования

#### Уровни логирования
- **INFO** - Общая информация
- **WARNING** - Предупреждающие сообщения
- **ERROR** - Сообщения об ошибках

#### Назначения логирования
- **Вывод в консоль** - Логирование для разработки
- **Файлы логов** - Постоянное логирование
- **Системный лог** - Интеграция с системным логированием

### Возможности отладки

#### Отладка агента
- **Трассировка команд** - Логирование всех входящих команд
- **Метрики производительности** - Отслеживание производительности компонентов
- **Мониторинг подключений** - Статус клиентских подключений

#### Отладка GUI
- **Сетевая отладка** - Логирование IPC коммуникации
- **Отладка UI** - Отслеживание состояния виджетов
- **Мониторинг производительности** - Метрики отзывчивости UI

## Будущая расширяемость

### Архитектура плагинов

#### Интерфейс плагинов
- **Стандартизированный API** - Общий интерфейс плагинов
- **Динамическая загрузка** - Загрузка плагинов времени выполнения
- **Конфигурация** - Управление конфигурацией плагинов

#### Точки расширения
- **Пользовательские менеджеры** - Новые менеджеры системных компонентов
- **Пользовательские вкладки** - Новые вкладки GUI
- **Пользовательские команды** - Новые типы команд
- **Пользовательские события** - Новые типы событий

### Эволюция протокола

#### Стратегия версионирования
- **Обратная совместимость** - Поддержка старых клиентов
- **Обнаружение возможностей** - Согласование возможностей
- **Graceful degradation** - Fallback для неподдерживаемых функций

#### Расширения протокола
- **Бинарный протокол** - Опциональный бинарный протокол для производительности
- **Сжатие** - Опциональное сжатие данных
- **Шифрование** - Опциональное шифрование данных

## Лучшие практики

### Организация кода

#### Соглашения об именовании
- **PascalCase** - Имена класс (AgentCore, MainWindow)
- **camelCase** - Имена функций (initialize(), sendCommand())
- **snake_case** - Имена переменных (system_info_, client_socket_)
- **UPPER_CASE** - Константы (MAX_CLIENTS, BUFFER_SIZE)

#### Организация файлов
- **Защита заголовков** - `#pragma once` для заголовочных файлов
- **Предварительные объявления** - Сокращение зависимостей компиляции
- **Разделение реализации** - Четкое разделение интерфейса и реализации

### Управление памятью

#### Принципы RAII
- **Умные указатели** - Автоматическое управление памятью
- **Очистка ресурсов** - Очистка на основе деструкторов
- **Безопасность исключений** - Сильные гарантии безопасности исключений

#### Семантика владения
- **Четкое владение** - Явная семантика владения
- **Избежание циклов** - Предотвращение циклических ссылок
- **Лимиты ресурсов** - Предотвращение утечек ресурсов

### Обработка ошибок

#### Согласованная обработка ошибок
- **Стандартизированные ошибки** - Согласованная отчетность об ошибках
- **Контекст ошибок** - Предоставление контекстной информации об ошибках
- **Стратегии восстановления** - Определение подходов к восстановлению ошибок

#### Лучшие практики логирования
- **Структурированное логирование** - Согласованный формат логов
- **Соответствующие уровни** - Использование соответствующих уровней логирования
- **Соображения производительности** - Избежание логирования в горячих путях

Это руководство по архитектуре предоставляет комплексное понимание структуры проекта SysMon3, отношений компонентов и проектных решений. Оно служит справочником для разработчиков, работающих над расширением, поддержкой или пониманием системы.
